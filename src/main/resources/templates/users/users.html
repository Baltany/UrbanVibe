<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <head th:replace="fragments/head :: head"></head>
    <title>UrbanVibe</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <th:block th:replace="~{fragments/main.html :: headerfiles}"></th:block>
    
</head>
<body>
      
        <div th:replace="~{fragments/main.html :: navigation}"> </div>
        <div class="container">
            <br>
        <h3>Lista de usuarios</h3>
        <br/>
        <table class="table table-striped">
          <thead>
            <tr>
            <td>
              Usuario 
              <!--
              <i class="fa-regular fa-user" style="color: #000000;"></i>
              
                Nombre de Usuario
              -->
            </td>
            <td>Nombre</td>
            <td>Apellidos</td>
            <td>Email
              <!--<i class="fa-thin fa-at" style="color: #000000;"></i></i>
              Email--></td>
            <td>DNI  
              <!--<i class="fa-solid fa-id-card" style="color: #000000;"></i>
              DNI--></td>
            <td>Habilitado</td>
            <td>
              Dirección
              <!--<i class="fa-solid fa-location-dot" style="color: #000000;"></i>
              
                Dirección
            -->
          </td>
            <td>Rol</td>
            <!-- <td>Pedidos</td> -->
            <td>
              <i class="fa-solid fa-gear" style="color: #000000;"></i>
              <!--Acciones-->
            </td>
            </tr>
          </thead>
          <tbody>
            <tr th:each="user: ${users}">

              <td th:text="${user.username}"></td>
              <td th:text="${user.name}"></td>
              <td th:text="${user.surname}"></td>
              <td th:text="${user.mail}"></td>
              <td th:text="${user.dni}"></td>
              <td>
                
                  <input type="checkbox" th:checked="${user.enable}" disabled="disabled" />
                  <!--<i class="fa-solid fa-check"></i>   <i class="fa-solid fa-xmark"></i>-->
                
                <!--<span th:if="${user.enable}" class="fa-solid fa-check"></span>
                <span th:unless="${user.enable}" class="fa-solid fa-xmark"></span>-->
            </td>
            
            
              <td th:text="${user.address}"></td>
              <td>
                <p>
                    
                    <span th:each="role : ${user.rolList}" th:text="${role.rol}"></span>

    
                </p>
              </td>
                  
              <td>
                  <a class="btn btn-primary" th:href="|/users/edit/${user.id}|">
                    <i class="fa-solid fa-pen"></i>
                    <!--Editar-->
                  </a>
                  <a class="btn btn-danger" th:href="|/users/delete/${user.id}|"
                  data-toggle="modal"
                  data-target="#confirmDeleteModal"
                  th:data-user-id="${user.id}"
                  onclick="$('#confirmDeleteButton').data('user-id', $(this).data('user-id'))"
                  >
                  <i class="fa-solid fa-trash"></i>
                  <!--Borrar-->
                </a>
          
              </td>
            </tr>
          </tbody>
        </table>

        <!--  -->
        <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar borrado</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">×</span>
                </button>
              </div>
              <div class="modal-body">
                ¿Estás seguro que quieres borrar este usuario?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Borrar</button>
              </div>
            </div>
          </div>
        </div>
        <!--  -->
      </div>
      <div th:replace="~{fragments/main.html :: footer}"></div>
      <!-- Bootstrap JS and jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


  <script>
$(document).ready(function () {
    // Función para borrar un usuario al confirmar la eliminación
    $('#confirmDeleteButton').click(function (event) {
        // Obtener el ID de usuario almacenado en el botón de confirmación
        const usuarioId = $(this).data("user-id");

        // Verificar que el ID de usuario sea válido
        if (usuarioId) {
            // Obtener el token CSRF de la etiqueta meta
            const csrfToken = $("meta[name='_csrf']").attr("content");

            // Configurar la solicitud AJAX para eliminar el usuario
            $.ajax({
                type: "DELETE",
                url: "/users/delete/" + usuarioId,
                headers: {
                    "X-CSRF-TOKEN": csrfToken
                },
                success: function (response) {
                    console.log("Usuario borrado correctamente");
                    // Recargar la página después de borrar el usuario
                    location.reload();
                },
                error: function (error) {
                    console.error("Error al borrar el usuario:", error);
                    // Mostrar mensaje de error al usuario si es necesario
                    alert("Error al borrar el usuario. Consulta la consola para más detalles.");
                }
            });
        } else {
            console.error("ID de usuario no definido");
            console.log(url);
            // Mostrar mensaje de error al usuario si el ID no está definido
            alert("ID de usuario no definido. No se pudo borrar el usuario.");
        }
    });
});

</script>

  </body>
</html>